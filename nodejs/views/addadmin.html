<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Fundraiser</title>
    <style>
        
    </style>
      <link rel="stylesheet" href="/mainstyle.css">
      <script src="http://code.angularjs.org/1.2.25/angular.min.js"></script>
</head>
<body>
    <h1 id="pageTitle">Create New Fundraiser</h1>
    <form id="fundraiserForm">
        <div>
            <label for="organizer">Organizer:</label>
            <input type="text" id="organizer" name="ORGANIZER" required>
            
        </div>
        <div>
            <label for="caption">Caption:</label>
            <input type="text" id="caption" name="CAPTION" required>
        
        </div>
        <div>
            <label for="targetFunding">Target Funding:</label>
            <input type="number" id="targetFunding" name="TARGET_FUNDING" required>
            
        </div>
        <div>
            <label for="currentFunding">Current Funding:</label>
            <input type="number" id="currentFunding" name="CURRENT_FUNDING" value="0" required>
            
        </div>
        <div>
            <label for="city">City:</label>
            <input type="text" id="city" name="CITY" required>
            
        </div>
        <div>
            <label for="active">Active:</label>
            <select id="active" name="ACTIVE" required>
                <option value="1">Yes</option>
                <option value="0">No</option>
            </select>
            
        </div>
        <div>
            <label for="categoryId">Category ID:</label>
            <input type="number" id="categoryId" name="CATEGORY_ID" required>
            
        </div>
        <button type="submit">SAVE</button>
    </form>

    <script>
        let fundraiserId = null; 

        function getQueryParam(param) {
            const urlParams = new URLSearchParams(window.location.search);
            
            return urlParams.get(param);
        }

        document.addEventListener('DOMContentLoaded', async () => {
            fundraiserId = getQueryParam('id'); 
        

            if (fundraiserId) {
                document.getElementById('pageTitle').textContent = 'Update Fundraiser'; 

                try {
                    const response = await fetch(`/api/fundraiser/${fundraiserId}`); 
                    const fundraiser = await response.json();

                    document.getElementById('organizer').value = fundraiser.ORGANIZER;
                    document.getElementById('caption').value = fundraiser.CAPTION;
                    document.getElementById('targetFunding').value = fundraiser.TARGET_FUNDING;
                    document.getElementById('currentFunding').value = fundraiser.CURRENT_FUNDING;
                    document.getElementById('city').value = fundraiser.CITY;
                    document.getElementById('active').value = fundraiser.ACTIVE ? '1' : '0';
                    document.getElementById('categoryId').value = fundraiser.CATEGORY_ID;
                } catch (error) {
                    console.error('Error fetching fundraiser data:', error);
                    alert('An error occurred while fetching the fundraiser data.');
                }
            }
        });

        document.getElementById('fundraiserForm').addEventListener('submit', async function(event) {
            event.preventDefault();

            clearErrors();

            const formData = new FormData(this);
            const data = Object.fromEntries(formData.entries());

            let isValid = true;
            for (const key in data) {
                if (!data[key]) {
                    document.getElementById(`${key}Error`).textContent = 'This field is required';
                    isValid = false;
                }
            }

            if (!isValid) {
                return;
            }

            try {
                const method = fundraiserId ? 'PUT' : 'POST'; 
                const url = fundraiserId ? `/api/fundraiser/${fundraiserId}` : '/api/fundraiser';

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                if (response.ok) {
                    alert(fundraiserId ? 'Fundraiser updated successfully!' : 'Fundraiser created successfully!');
                    this.reset();
                    fundraiserId = null; 
                    document.getElementById('pageTitle').textContent = 'Create New Fundraiser'; 
                    window.history.back()
                } else {
                    alert(`Failed to ${fundraiserId ? 'update' : 'create'} fundraiser: ` + result.message);
                }
            } catch (error) {
                console.error('Error:', error);
                alert(`An error occurred while ${fundraiserId ? 'updating' : 'creating'} the fundraiser.`);
            }
        });

        function clearErrors() {
            const errorElements = document.querySelectorAll('.error');
            errorElements.forEach(element => element.textContent = '');
        }
    </script>
</body>
</html>